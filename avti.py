import os
from colorama import Fore
from tqdm import tqdm

os.chdir(os.getcwd())
path = os.getcwd() + '/VirusShare_Hashes'
#os.system("ls -t VirusShare_Hashes | head -n1 | grep -o '[0-9]*' | sed 's/5$//' > last.txt")
#lf = open('last.txt','r')
#l = lf.readline()
#l = int(l)
#print(l)
files = os.listdir(path)
total_files = len(files)
files_processed = 0
flag = 0
file_name = path + '/VirusShare_'

def hash_checker(hashin):
	global files_processed
	with tqdm(total=100) as pbar:
		for i in range(0,total_files):	
			num_s = str(i)
			files_processed += 1
			progress_percentage = (files_processed / total_files) * 100
			pbar.update(progress_percentage - pbar.n)
			num = num_s.zfill(5)
			hash_file = file_name + num + '.md5'
			pbar.set_postfix_str('VirusShare_'+ num)
			try:
				#print("reading file : "+ hash_file)

				with open(hash_file,'r') as hashes:
					for s_hash in hashes:
						s_hash = s_hash.strip()
						#print("hash in  : ",hashin)
						if(hashin == s_hash):
							global flag
							#print("here")
							flag = 1
							return num
						else:
							flag = 0			
			except FileNotFoundError:
				print(Fore.GREEN + "\nSearched through all database")
				break
			except:
				print("Error")
				break


filein = input("Enter file path :" ) or '/home/master/nmap.sh'
temp = 'md5sum ' + filein + '> calc_hash.txt'
temp2 = os.system(temp)
f1 = open('calc_hash.txt','r')
l1 = f1.readline()
hashin = l1.partition(' ')[0]
print("hash of file is : ",hashin)
val = hash_checker(hashin)
if(flag == 1 ):
	print(Fore.RED + "FILE IS INFECTED")
	print("Hash found in database file : ", 'VirusShare_' +  val +'.md5')
else:
	print(Fore.GREEN + "FILE IS SAFE")
					
